<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGH Profit Calculator / LGH Vinstbereknare</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="CoolPortals.PNG">
    <link rel="apple-touch-icon" href="CoolPortals.PNG">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Ber√§kna vinst vid f√∂rs√§ljning av l√§genhet i Sverige. Gratis vinstkalkylator med skatt, l√•n och alla avdrag.">
    <meta name="keywords" content="l√§genhet, vinst, kalkylator, f√∂rs√§ljning, skatt, Sverige, BRF">
    <meta name="author" content="CoolPortals">
    
    <!-- Open Graph for social sharing -->
    <meta property="og:title" content="Kalkylator f√∂rs√§ljning LGH">
    <meta property="og:description" content="Gratis vinstkalkylator f√∂r bostadsf√∂rs√§ljning i Sverige">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://howcan66.github.io/vinst-p--lgh/">
    <meta property="og:image" content="https://howcan66.github.io/vinst-p--lgh/CoolPortals.PNG">
    
    <!-- Mobile optimization -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            padding: 8px;
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            margin-bottom: 4px;
            padding: 12px 16px;
            background: #000;
            border-radius: 8px;
        }

        .header h1 {
            font-size: 15px;
            font-weight: 700;
            margin: 0;
        }

        .header .subtitle {
            display: none;
        }

        .card {
            background: #000;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.15);
            margin-bottom: 4px;
            overflow: hidden;
        }

        .card-header {
            display: none;
        }

        .card-body {
            padding: 12px 16px;
        }

        .input-group {
            margin-bottom: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0px;
            align-items: center;
        }

        .input-group.full {
            grid-template-columns: 1fr;
        }

        .input-label {
            font-size: 14px;
            color: #fff;
            font-weight: 700;
            text-align: left;
        }

        .input-field {
            padding: 4px 6px;
            border: 1px solid #fff;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: #fff;
            color: #000;
            height: 24px;
        }

        .input-field:focus {
            outline: none;
            border-color: #fff;
            background: #fff;
        }

        .status-text {
            font-size: 11px;
            color: #aaa;
            margin-top: 4px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            margin-top: 12px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            text-align: left;
        }

        .output-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid #333;
        }

        .output-row:last-child {
            border-bottom: none;
        }

        .output-label {
            font-size: 14px;
            color: #fff;
            font-weight: 700;
            text-align: left;
        }

        .output-label[data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: normal;
            white-space: nowrap;
            z-index: 1000;
            bottom: 130%;
            left: 0;
        }

        .output-label[data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: 120%;
            left: 10px;
            width: 0;
            height: 0;
            border: 5px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .output-label {
            position: relative;
        }

        .output-value {
            text-align: right;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            font-family: 'Courier New', monospace;
        }

        .language-toggle {
            display: flex;
            gap: 4px;
        }

        .lang-btn {
            padding: 6px 12px;
            margin: 0 2px;
            border: 1px solid #fff;
            background: #000;
            color: #fff;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .lang-btn.active {
            background: #fff;
            color: #000;
        }

        .lang-btn:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .lang-btn[data-tooltip]:hover::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            padding: 4px 8px;
            background: #333;
            color: #fff;
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1000;
        }

        .lang-btn[data-tooltip]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        .refresh-link {
            background: transparent;
            border: none;
            color: #4da3ff;
            text-decoration: underline;
            padding: 0;
            margin: 0 2px;
            box-shadow: none;
            border-radius: 0;
            font-weight: 600;
            min-width: 0;
            height: auto;
            line-height: 1.2;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .refresh-link:hover {
            box-shadow: none;
            color: #7bb9ff;
        }

        .icon-btn {
            padding: 6px 8px;
            margin: 0 2px;
            border: 1px solid #fff;
            background: #000;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Print-friendly styling */
        @media print {
            body {
                background: #1a1a2e !important;
                color: #fff !important;
            }
            .header,
            .lang-btn,
            .icon-btn,
            .secret-btn,
            button {
                display: none !important;
            }
            .card {
                box-shadow: none;
                border: 1px solid #667eea;
                background: #16213e !important;
            }
            .card-header {
                background: #0f3460 !important;
                color: #fff !important;
                padding: 8px 12px !important;
                margin-bottom: 8px !important;
            }
            .card-body {
                padding: 8px 12px !important;
            }
            .input-group {
                margin-bottom: 4px !important;
            }
            .input-label {
                color: #fff !important;
                font-size: 12px !important;
                margin-bottom: 2px !important;
            }
            .input-field {
                border: none;
                border-bottom: 1px solid #667eea;
                background: #0f3460 !important;
                color: #fff !important;
                padding: 4px 8px !important;
                font-size: 12px !important;
            }
            .output-row {
                padding: 3px 0 !important;
                border-bottom: 1px solid #333 !important;
            }
            .output-label {
                color: #fff !important;
                font-size: 12px !important;
            }
            .output-value {
                color: #fff !important;
                font-size: 12px !important;
            }
            footer {
                display: none !important;
            }
        }

        .icon-btn img {
            height: 20px;
            width: 20px;
            border-radius: 4px;
        }

        .secret-btn {
            background: #000;
            border: 1px solid #000;
            color: #000;
        }

        /* Sales Objects visibility toggle (LGH.111) */
        #sales-objects-toggle {
            background: #000;
            border: 1px solid #000;
            color: #000;
            padding: 6px 12px;
            width: 32px;              /* Fixed width so the invisible target is easier to hit */
            height: 28px;             /* Fixed height matching other buttons */
            margin-right: 8px;        /* Extra gap so the blank button has a clear click area */
        }

        /* Hide Sales Objects section when toggled */
        .sales-objects-hidden #label-obj1,
        .sales-objects-hidden #obj1-url,
        .sales-objects-hidden #obj1-fetch-btn,
        .sales-objects-hidden #obj1-prev-btn,
        .sales-objects-hidden #obj1-open-btn,
        .sales-objects-hidden #obj1-next-btn,
        .sales-objects-hidden #obj1-scrape-btn,
        .sales-objects-hidden #obj1-delete-btn,
        .sales-objects-hidden #obj1-delete-all-btn,
        .sales-objects-hidden #obj1-counter,
        .sales-objects-hidden #label-buyer-purchase,
        .sales-objects-hidden #inkopspris_kopare {
            display: none !important;
        }

        /* Print: respect toggle state */
        @media print {
            .sales-objects-hidden #label-obj1,
            .sales-objects-hidden #obj1-url,
            .sales-objects-hidden #obj1-fetch-btn,
            .sales-objects-hidden #obj1-prev-btn,
            .sales-objects-hidden #obj1-open-btn,
            .sales-objects-hidden #obj1-next-btn,
            .sales-objects-hidden #obj1-scrape-btn,
            .sales-objects-hidden #obj1-delete-btn,
            .sales-objects-hidden #obj1-delete-all-btn,
            .sales-objects-hidden #obj1-counter,
            .sales-objects-hidden #label-buyer-purchase,
            .sales-objects-hidden #inkopspris_kopare {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            .input-group {
                grid-template-columns: 1fr;
            }

            .input-label {
                font-size: 11px;
            }

            .input-field {
                font-size: 13px;
            }

            .output-row {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .output-value {
                text-align: left;
            }

            .header h1 {
                font-size: 12px;
                font-weight: normal;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 8px;">
            <h1 id="title">Kalkylator F√∂rs√§ljning LGH</h1>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
            <button type="button" class="lang-btn secret-btn" id="sales-objects-toggle" aria-label="Toggle Sales Objects"></button>
            <a href="S13.Passcode.html" target="_blank" class="lang-btn secret-btn" aria-label="Secret access">S13</a>
            <button class="lang-btn" id="refresh-btn" onclick="location.reload()" aria-label="Refresh page" data-tooltip="Refresh">üîÑ</button>
            <button class="lang-btn active" data-lang="sv" aria-label="Swedish language" data-tooltip="Swedish">SV</button>
            <button class="lang-btn" data-lang="en" aria-label="English language" data-tooltip="English">EN</button>
            <button class="lang-btn" id="print-btn" aria-label="Print calculations" data-tooltip="Print">üñ®Ô∏è</button>
            <button class="lang-btn" id="email-btn" aria-label="Email results" data-tooltip="Email">‚úâÔ∏è</button>
            <button class="lang-btn" id="clear-btn" aria-label="Clear saved data" data-tooltip="Clear">üóëÔ∏è</button>
        </div>
    </div>

    <!-- Input Card -->
    <div class="card">
        <div class="card-header" id="input-header">Ber√§kningsdata</div>
        <div class="card-body">
            <!-- Object Information Section -->
            <div style="border-bottom: 2px solid #667eea; padding-bottom: 8px; margin-bottom: 8px;">
                <div style="color: #999; font-size: 12px; margin-bottom: 6px;">‚îÄ‚îÄ‚îÄ <span id="label-obj-info">OBJEKT INFORMATION</span> ‚îÄ‚îÄ‚îÄ</div>
                <div class="input-group">
                    <label class="input-label" id="label-name">Namn</label>
                    <input type="text" id="obj-name" class="input-field" placeholder="" inputmode="text">
                </div>
                <div class="input-group">
                    <label class="input-label" id="label-contact">Kontakt</label>
                    <input type="text" id="obj-contact" class="input-field" placeholder="" inputmode="tel">
                </div>
                <div class="input-group">
                    <label class="input-label" id="label-description">Fastighetsbeskrivning</label>
                    <input type="text" id="obj-description" class="input-field" placeholder="" inputmode="text">
                </div>
            </div>

            <div class="input-group full" style="margin-bottom: 8px;">
                <label class="input-label" id="label-obj1">K√∂p Objekt</label>
                <div style="display: flex; gap: 2px; align-items: center; flex-wrap: wrap;">
                    <input type="text" id="obj1-url" class="input-field" placeholder="https://..." inputmode="url" aria-label="Objektl√§nk" style="flex: 1 1 110px; max-width: 160px;" title="">
                    <button type="button" class="lang-btn" id="obj1-fetch-btn" data-tooltip="H√§mta pris">GURL</button>
                    <button type="button" class="lang-btn" id="obj1-prev-btn" data-tooltip="F√∂reg√•ende">&lt;&lt;</button>
                    <button type="button" class="lang-btn" id="obj1-open-btn" data-tooltip="√ñppna">&gt;</button>
                    <button type="button" class="lang-btn" id="obj1-next-btn" data-tooltip="N√§sta">&gt;&gt;</button>
                    <button type="button" class="lang-btn" id="obj1-scrape-btn" data-tooltip="Skrapa pris">:)</button>
                    <button type="button" class="lang-btn" id="obj1-delete-btn" data-tooltip="Radera aktuell">D1</button>
                    <button type="button" class="lang-btn" id="obj1-delete-all-btn" data-tooltip="Radera alla">DD</button>
                    <span id="obj1-counter" style="color: #fff; font-size: 12px; margin-left: 4px;">1/1</span>
                </div>
                <div class="status-text" id="obj1-status"></div>
            </div>
            <!-- Buyer Purchase Price Section -->
            <div class="input-group">
                <label class="input-label" id="label-buyer-purchase">Ink√∂pspris (kr)</label>
                <input type="text" id="inkopspris_kopare" class="input-field number-field" value="" inputmode="numeric">
            </div>
            <!-- Sale Price Section -->
            <div class="input-group">
                <label class="input-label" id="label-price">F√∂rs√§ljningspris (kr)</label>
                <input type="text" id="forsaljningspris" class="input-field number-field" value="4350000" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-loan">L√•n (kr)</label>
                <input type="text" id="lan" class="input-field number-field" value="1950000" inputmode="numeric">
            </div>

            <!-- Acquisition Costs Section -->
            <div class="input-group">
                <label class="input-label" id="label-purchase">Ink√∂pspris (kr)</label>
                <input type="text" id="inkopspris" class="input-field number-field" value="380000" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-broker">M√§klararvode (kr)</label>
                <input type="text" id="maklararvode" class="input-field number-field" value="65000" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-styling">Styling (kr)</label>
                <input type="text" id="styling" class="input-field number-field" value="0" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-photo">Fotografering (kr)</label>
                <input type="text" id="fotografering" class="input-field number-field" value="0" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-reno">Renoveringskostnader (kr)</label>
                <input type="text" id="renoveringskostnader" class="input-field number-field" value="200000" inputmode="numeric">
            </div>
            <div class="input-group">
                <label class="input-label" id="label-other">√ñvriga avdragsgilla (kr)</label>
                <input type="text" id="ovriga" class="input-field number-field" value="0" inputmode="numeric">
            </div>
            <div class="input-group" style="margin-bottom: 2px;">
                <label class="input-label" id="label-capital">Kapitaltillskott, from BRF (kr)</label>
                <input type="text" id="kapitaltillskott" class="input-field number-field" value="10000" inputmode="numeric">
            </div>

            <div class="input-group" style="display: none;">
                <label class="input-label" id="label-taxrate">Skattesats (%)</label>
                <input type="text" id="skattesats" class="input-field number-field" value="22" inputmode="numeric">
            </div>
        </div>
    </div>

    <!-- Result Card -->
    <div class="card">
        <div class="card-header" id="result-header">Resultat</div>
        <div class="card-body">
            <div class="output-row">
                <div class="output-label" id="label-calc1">Totalt avdrag (kr)</div>
                <div class="output-value" id="result-calc1">‚Äì</div>
            </div>
            <div class="output-row">
                <div class="output-label" id="label-calc2">Vinst f√∂re skatt (kr)</div>
                <div class="output-value" id="result-calc2">‚Äì</div>
            </div>
            <div class="output-row">
                <div class="output-label" id="label-calc3">Skatt (kr & 22%)</div>
                <div class="output-value" id="result-calc3">‚Äì</div>
            </div>
            <div class="output-row">
                <div class="output-label" id="label-calc4">Nettoresultat efter skatt (kr)</div>
                <div class="output-value" id="result-calc4">‚Äì</div>
            </div>
            <div class="output-row" style="border-top: 2px solid #667eea; padding-top: 12px; margin-top: 8px; font-weight: 700;">
                <div class="output-label" id="label-calc5">Vinst efter avdrag f√∂r l√•n (kr)</div>
                <div class="output-value" id="result-calc5">‚Äì</div>
            </div>
            <div class="output-row">
                <div class="output-label" id="label-slutlikvid" data-tooltip="F√∂rs√§ljningspris - M√§klararvode - L√•n">Slutlikvid (kr)</div>
                <div class="output-value" id="result-slutlikvid">‚Äì</div>
            </div>
        </div>
    </div>

    <div style="color: white; font-size: 10px; margin-top: 16px; opacity: 0.8; text-align: center;">
        <p><a href="mailto:coolportals@hotmail.com" style="color: white; text-decoration: none;">coolportals@hotmail.com</a> | ¬© 2026 Vinstkalkylator | <span id="footer-left"></span></p>
    </div>
</div>

<script>
    // Language strings
    const translations = {
        sv: {
            title: 'Kalkylator F√∂rs√§ljning LGH',
            inputHeader: 'Ber√§kningsdata',
            resultHeader: 'Resultat',
            refreshLink: 'Uppdatera sidan',
            labelObjInfo: 'OBJEKT INFORMATION',
            labelName: 'Namn',
            labelContact: 'Kontakt',
            labelDescription: 'Fastighetsbeskrivning',
            labelBuyerPurchase: 'Ink√∂pspris (kr)',
            labelPrice: 'F√∂rs√§ljningspris (kr)',
            labelLoan: 'L√•n (kr)',
            labelPurchase: 'Ink√∂pspris (kr)',
            labelBroker: 'M√§klararvode (kr)',
            labelStyling: 'Styling (kr)',
            labelPhoto: 'Fotografering (kr)',
            labelReno: 'Renoveringskostnader (kr)',
            labelOther: '√ñvriga avdragsgilla kostnader (kr)',
            labelCapital: 'Kapitaltillskott, from BRF (kr)',
            labelTaxrate: 'Skattesats (%)',
            labelCalc1: 'Totalt avdrag (kr)',
            labelCalc2: 'Vinst f√∂re skatt (kr)',
            labelCalc3: 'Skatt 22% (kr)',
            labelCalc4: 'Nettoresultat efter skatt (kr)',
            labelCalc5: 'Vinst efter avdrag (kr)',
            labelSlutikvid: 'Slutlikvid (kr)',
            tooltipSlutikvid: 'F√∂rs√§ljningspris - M√§klararvode - L√•n',
            obj1Label: 'K√∂p Objekt',
            obj1Fetch: 'Ladda URL',
            obj1Prev: 'F√∂reg√•ende',
            obj1Open: '√ñppna',
            obj1Next: 'N√§sta',
            obj1Scrape: 'Skrapa pris',
            obj1DeleteCurrent: 'Radera aktuell',
            obj1DeleteAll: 'Radera alla'
        },
        en: {
            title: 'Apartment Sales Profit Calculator',
            inputHeader: 'Calculation Data',
            resultHeader: 'Results',
            refreshLink: 'Refresh page',
            labelObjInfo: 'PROPERTY INFORMATION',
            labelName: 'Name',
            labelContact: 'Contact',
            labelDescription: 'Property Description',
            labelBuyerPurchase: 'Purchase Price (SEK)',
            labelPrice: 'Sales Price SEK',
            labelLoan: 'Loan Amount (SEK)',
            labelPurchase: 'Purchase Price (SEK)',
            labelBroker: 'Broker Fee (SEK)',
            labelStyling: 'Styling (SEK)',
            labelPhoto: 'Photography (SEK)',
            labelReno: 'Renovation Costs (SEK)',
            labelOther: 'Other Deductible Costs (SEK)',
            labelCapital: 'Capital Contribution, from BRF (SEK)',
            labelTaxrate: 'Tax Rate (%)',
            labelCalc1: 'Total Deductions (SEK)',
            labelCalc2: 'Profit Before Tax (SEK)',
            labelCalc3: 'Tax 22% (SEK)',
            labelCalc4: 'Net Result After Tax (SEK)',
            labelCalc5: 'Profit After Deductions (SEK)',
            labelSlutikvid: 'Total Final Payment (SEK)',
            tooltipSlutikvid: 'Sale Price - Broker Fee - Loan',
            obj1Label: 'Sales Objects',
            obj1Fetch: 'Load URL',
            obj1Prev: 'Previous',
            obj1Open: 'Open',
            obj1Next: 'Next',
            obj1Scrape: 'Scrape price',
            obj1DeleteCurrent: 'Delete current',
            obj1DeleteAll: 'Delete all'
        }
    };

    let currentLang = 'sv';

    // Helpers
    function parseNumber(value) {
        return parseFloat(String(value || '').replace(/\s/g, '')) || 0;
    }

    function formatNumber(value) {
        return Number(value || 0).toLocaleString('sv-SE');
    }

    function isValidHttpUrl(value) {
        try {
            const u = new URL(value);
            return u.protocol === 'http:' || u.protocol === 'https:';
        } catch (e) {
            return false;
        }
    }

    // Format currency (whole kronor)
    function formatSEK(value) {
        return new Intl.NumberFormat('sv-SE', {
            style: 'currency',
            currency: 'SEK',
            maximumFractionDigits: 0
        }).format(value);
    }

    // URL normalizer
    function normalizeUrl(url) {
        if (!url) return '';
        return /^https?:\/\//i.test(url) ? url : 'https://' + url;
    }

    // Extract price from HTML string
    function extractPriceFromHtml(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const metaSelectors = [
            'meta[property="product:price:amount"]',
            'meta[property="og:price:amount"]',
            'meta[name="price"]',
            'meta[itemprop="price"]'
        ];
        for (const sel of metaSelectors) {
            const m = doc.querySelector(sel);
            if (m && m.content) {
                const val = parseNumber(m.content);
                if (val > 0) return val;
            }
        }
        const dataPriceEl = doc.querySelector('[data-price]');
        if (dataPriceEl) {
            const val = parseNumber(dataPriceEl.getAttribute('data-price') || dataPriceEl.textContent);
            if (val > 0) return val;
        }
        const text = html.replace(/\n/g, ' ');
        const match = text.match(/([0-9][0-9\s]{4,})\s?(kr|sek)/i);
        if (match) {
            const val = parseNumber(match[1]);
            if (val > 0) return val;
        }
        return null;
    }

    const objStatus = {
        sv: {
            fetching: 'H√§mtar pris...',
            notFound: 'Not Loaded',
            error: 'Not Loaded',
            set: (v) => `Pris h√§mtat: ${formatNumber(v)} kr`
        },
        en: {
            fetching: 'Fetching price...',
            notFound: 'Not Loaded',
            error: 'Not Loaded',
            set: (v) => `Price fetched: ${formatNumber(v)} SEK`
        }
    };

    // Get input values
    function getInputs() {
        return {
            objName: document.getElementById('obj-name').value,
            objContact: document.getElementById('obj-contact').value,
            objDescription: document.getElementById('obj-description').value,
            forsaljningspris: parseNumber(document.getElementById('forsaljningspris').value),
            inkopspris_kopare: parseNumber(document.getElementById('inkopspris_kopare').value),
            lan: parseNumber(document.getElementById('lan').value),
            inkopspris: parseNumber(document.getElementById('inkopspris').value),
            maklararvode: parseNumber(document.getElementById('maklararvode').value),
            styling: parseNumber(document.getElementById('styling').value),
            fotografering: parseNumber(document.getElementById('fotografering').value),
            renoveringskostnader: parseNumber(document.getElementById('renoveringskostnader').value),
            ovriga: parseNumber(document.getElementById('ovriga').value),
            kapitaltillskott: parseNumber(document.getElementById('kapitaltillskott').value),
            skattesats: Math.max(0, Math.min(100, parseNumber(document.getElementById('skattesats').value))) / 100
        };
    }

    // Calculate all values
    function calculate() {
        const inputs = getInputs();

        // calc1: Totalt avdrag = Sum of all acquisition costs + Kapitaltillskott
        const calc1 = inputs.inkopspris + inputs.maklararvode + inputs.styling + 
                      inputs.fotografering + inputs.renoveringskostnader + inputs.ovriga + 
                      inputs.kapitaltillskott;

        // calc2: Vinst f√∂re skatt = F√∂rs√§ljningspris - calc1
        const calc2 = inputs.forsaljningspris - calc1;

        // calc3: Skatt = calc2 * skattesats
        const calc3 = calc2 * inputs.skattesats;

        // calc4: Nettoresultat efter skatt = calc2 - calc3
        const calc4 = calc2 - calc3;

        // calc5: Vinst efter l√•n = calc4 - L√•n
        const calc5 = calc4 - inputs.lan;

        // slutlikvid: Total Final Payment = F√∂rs√§ljningspris - M√§klararvode - L√•n
        const slutlikvid = inputs.forsaljningspris - inputs.maklararvode - inputs.lan;

        // Update UI
        document.getElementById('result-calc1').textContent = formatSEK(calc1);
        document.getElementById('result-calc2').textContent = formatSEK(calc2);
        document.getElementById('result-calc3').textContent = formatSEK(calc3);
        document.getElementById('result-calc4').textContent = formatSEK(calc4);
        document.getElementById('result-calc5').textContent = formatSEK(calc5);
        document.getElementById('result-slutlikvid').textContent = formatSEK(slutlikvid);
    }

    // Update language
    function setLanguage(lang) {
        currentLang = lang;
        const t = translations[lang];

        document.getElementById('title').textContent = t.title;
        document.getElementById('input-header').textContent = t.inputHeader;
        document.getElementById('result-header').textContent = t.resultHeader;
        document.getElementById('label-obj1').textContent = t.obj1Label;

        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.setAttribute('data-tooltip', lang === 'sv' ? 'Uppdatera' : 'Refresh');
        }

        const fetchBtn = document.getElementById('obj1-fetch-btn');
        if (fetchBtn) {
            fetchBtn.textContent = 'GURL';
            fetchBtn.setAttribute('data-tooltip', t.obj1Fetch);
        }
        
        // Update Sales Objects tooltips
        updateObjectsTooltips();
        const fetchObjBtn = document.getElementById('fetch-obj1-btn');
        if (fetchObjBtn) {
            fetchObjBtn.setAttribute('data-tooltip', t.obj1Fetch);
        }
        document.getElementById('label-obj-info').textContent = t.labelObjInfo;
        document.getElementById('label-name').textContent = t.labelName;
        document.getElementById('label-contact').textContent = t.labelContact;
        document.getElementById('label-description').textContent = t.labelDescription;
        document.getElementById('label-price').textContent = t.labelPrice;
        document.getElementById('label-buyer-purchase').textContent = t.labelBuyerPurchase;
        document.getElementById('label-loan').textContent = t.labelLoan;
        document.getElementById('label-purchase').textContent = t.labelPurchase;
        document.getElementById('label-broker').textContent = t.labelBroker;
        document.getElementById('label-styling').textContent = t.labelStyling;
        document.getElementById('label-photo').textContent = t.labelPhoto;
        document.getElementById('label-reno').textContent = t.labelReno;
        document.getElementById('label-other').textContent = t.labelOther;
        document.getElementById('label-capital').textContent = t.labelCapital;
        document.getElementById('label-taxrate').textContent = t.labelTaxrate;
        document.getElementById('label-calc1').textContent = t.labelCalc1;
        document.getElementById('label-calc2').textContent = t.labelCalc2;
        document.getElementById('label-calc3').textContent = t.labelCalc3;
        document.getElementById('label-calc4').textContent = t.labelCalc4;
        document.getElementById('label-calc5').textContent = t.labelCalc5;
        document.getElementById('label-slutlikvid').textContent = t.labelSlutikvid;
        document.getElementById('label-slutlikvid').setAttribute('data-tooltip', t.tooltipSlutikvid);

        // Update button states
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-lang="${lang}"]`).classList.add('active');

        // Update timestamp to reflect language change
        updateTimestamp();

        // Recalculate to ensure formatting is correct
        calculate();

        // Persist language choice
        saveData();
    }

    // Event listeners
    document.querySelectorAll('.input-field').forEach(input => {
        input.addEventListener('input', calculate);
    });

    document.querySelectorAll('.lang-btn[data-lang]').forEach(btn => {
        btn.addEventListener('click', () => {
            setLanguage(btn.getAttribute('data-lang'));
        });
    });

    // ===== Sales Objects Memory System (LGH.95) =====
    const objUrlInput = document.getElementById('obj1-url');
    const objStatusEl = document.getElementById('obj1-status');
    const objCounterEl = document.getElementById('obj1-counter');
    
    // Memory management
    let objectsMemory = []; // Array of { url: string, savedPrice: number }
    let currentObjectIndex = 0;

    function loadObjectsMemory() {
        try {
            const saved = localStorage.getItem('lghObjectsMemory');
            if (saved) {
                objectsMemory = JSON.parse(saved);
            } else {
                objectsMemory = [];
            }
            currentObjectIndex = Math.max(0, parseInt(localStorage.getItem('lghCurrentObjectIndex')) || 0);
            if (currentObjectIndex >= objectsMemory.length) {
                currentObjectIndex = 0;
            }
        } catch (e) {
            console.error('Failed to load objects memory:', e);
            objectsMemory = [];
            currentObjectIndex = 0;
        }
    }

    function saveObjectsMemory() {
        try {
            localStorage.setItem('lghObjectsMemory', JSON.stringify(objectsMemory));
            localStorage.setItem('lghCurrentObjectIndex', currentObjectIndex.toString());
        } catch (e) {
            console.error('Failed to save objects memory:', e);
        }
    }

    function updateObjectsUI() {
        if (objectsMemory.length === 0) {
            objUrlInput.value = '';
            objCounterEl.textContent = '0/0';
            objStatusEl.textContent = '';
            return;
        }
        const current = objectsMemory[currentObjectIndex] || { url: '', savedPrice: 0 };
        objUrlInput.value = current.url || '';
        objCounterEl.textContent = `${currentObjectIndex + 1}/${objectsMemory.length}`;
        objStatusEl.textContent = '';
    }

    function setObjStatus(key, value) {
        if (!objStatusEl) return;
        const messages = objStatus[currentLang] || objStatus.sv;
        if (key === 'set' && typeof messages.set === 'function') {
            objStatusEl.textContent = messages.set(value);
        } else {
            objStatusEl.textContent = messages[key] || '';
        }
    }

    // Add new object or update current
    function addOrUpdateObject(url) {
        if (!url) return;
        const normalizedUrl = normalizeUrl(url.trim());

        // If the URL already exists, just jump to it
        const existingIndex = objectsMemory.findIndex(o => o.url === normalizedUrl);
        if (existingIndex !== -1) {
            currentObjectIndex = existingIndex;
            saveObjectsMemory();
            updateObjectsUI();
            setObjStatus('');
            return;
        }

        // If empty, create first object
        if (objectsMemory.length === 0) {
            objectsMemory.push({ url: normalizedUrl, savedPrice: 0 });
            currentObjectIndex = 0;
        } else {
            const current = objectsMemory[currentObjectIndex];
            // If current object is empty, update it
            if (!current.url || current.url === '') {
                current.url = normalizedUrl;
            } else {
                // Current object already has a URL - create new object
                const newObject = { url: normalizedUrl, savedPrice: 0 };
                objectsMemory.push(newObject);
                currentObjectIndex = objectsMemory.length - 1; // Move to new object
            }
        }

        saveObjectsMemory();
        updateObjectsUI();
        setObjStatus(''); // Clear status
    }

    // Navigate to previous object
    function goToPrevious() {
        if (objectsMemory.length === 0) return;
        currentObjectIndex = (currentObjectIndex - 1 + objectsMemory.length) % objectsMemory.length;
        saveObjectsMemory();
        updateObjectsUI();
    }

    // Navigate to next object
    function goToNext() {
        if (objectsMemory.length === 0) return;
        currentObjectIndex = (currentObjectIndex + 1) % objectsMemory.length;
        saveObjectsMemory();
        updateObjectsUI();
    }

    // Open current URL in new window
    function openCurrentObject() {
        let url = objUrlInput.value.trim();
        if (!url && objectsMemory.length > 0) {
            const current = objectsMemory[currentObjectIndex];
            url = current?.url || '';
        }
        if (!url) {
            setObjStatus('notFound');
            return;
        }
        window.open(normalizeUrl(url), '_blank');
    }

    // GURL button: Save URL to memory without fetching
    function saveUrlToMemory() {
        const rawUrl = objUrlInput.value.trim();
        if (!rawUrl || !isValidHttpUrl(rawUrl)) {
            setObjStatus('notFound');
            return;
        }
        addOrUpdateObject(rawUrl);
        objUrlInput.value = ''; // Clear URL after saving
        setObjStatus(''); // Clear status
    }

    // Scrape/fetch price from current URL
    async function scrapeCurrentObject() {
        let rawUrl = objUrlInput.value.trim();
        if (!rawUrl && objectsMemory.length > 0) {
            rawUrl = objectsMemory[currentObjectIndex]?.url || '';
        }
        if (!rawUrl) {
            setObjStatus('notFound');
            return;
        }
        const url = normalizeUrl(rawUrl);
        setObjStatus('fetching');
        try {
            const res = await fetch(url, { mode: 'cors' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const html = await res.text();
            const price = extractPriceFromHtml(html);
            if (price && price > 0) {
                const buyerPriceInput = document.getElementById('inkopspris_kopare');
                if (buyerPriceInput) {
                    buyerPriceInput.value = formatNumber(price);
                    // Save to current object
                    objectsMemory[currentObjectIndex].savedPrice = price;
                    saveObjectsMemory();
                    calculate();
                    saveData();
                }
                setObjStatus('set', price);
            } else {
                setObjStatus('notFound');
            }
        } catch (e) {
            console.error('Scrape failed:', e);
            setObjStatus('error');
        }
    }

    // Delete current object
    function deleteCurrentObject() {
        if (objectsMemory.length <= 1) {
            // Delete last object - show 0/0
            objectsMemory = [];
            currentObjectIndex = 0;
        } else {
            objectsMemory.splice(currentObjectIndex, 1);
            if (currentObjectIndex >= objectsMemory.length) {
                currentObjectIndex = objectsMemory.length - 1;
            }
        }
        saveObjectsMemory();
        updateObjectsUI();
    }

    // Delete all objects
    function deleteAllObjects() {
        if (confirm(currentLang === 'sv' ? 'Radera alla objekt?' : 'Delete all objects?')) {
            objectsMemory = [];
            currentObjectIndex = 0;
            saveObjectsMemory();
            updateObjectsUI();
        }
    }

    // Event listeners for buttons
    document.getElementById('obj1-fetch-btn').addEventListener('click', saveUrlToMemory);
    document.getElementById('obj1-prev-btn').addEventListener('click', goToPrevious);
    document.getElementById('obj1-next-btn').addEventListener('click', goToNext);
    document.getElementById('obj1-open-btn').addEventListener('click', openCurrentObject);
    document.getElementById('obj1-scrape-btn').addEventListener('click', scrapeCurrentObject);
    document.getElementById('obj1-delete-btn').addEventListener('click', deleteCurrentObject);
    document.getElementById('obj1-delete-all-btn').addEventListener('click', deleteAllObjects);

    // ===== LGH.111: Sales Objects Toggle Button =====
    const toggleBtn = document.getElementById('sales-objects-toggle');
    const cardBody = document.querySelector('.card-body'); // Target the card containing Sales Objects section

    // Load initial toggle state (default: hidden on first visit)
    let salesObjectsToggleState = parseInt(localStorage.getItem('lghSalesObjectsToggle') || '1'); // 1=hidden, 2=shown, cycles

    // Apply initial state on page load
    function applySalesObjectsToggleState() {
        if (salesObjectsToggleState === 1 || salesObjectsToggleState % 2 === 1) {
            // Odd = HIDDEN
            cardBody.classList.add('sales-objects-hidden');
        } else {
            // Even = SHOWN
            cardBody.classList.remove('sales-objects-hidden');
        }
    }

    // Toggle Sales Objects section
    function toggleSalesObjects() {
        salesObjectsToggleState += 1; // Increment: 1‚Üí2‚Üí3(reset to 1)‚Üí2‚Üí...
        if (salesObjectsToggleState > 2) {
            salesObjectsToggleState = 1; // Cycle: after 2, go back to 1 (or continue: 3,4,5... and check odd/even)
        }
        localStorage.setItem('lghSalesObjectsToggle', salesObjectsToggleState.toString());
        applySalesObjectsToggleState();
    }

    toggleBtn.addEventListener('click', toggleSalesObjects);

    // Apply initial state on load
    applySalesObjectsToggleState();

    // Update tooltips on language change
    function updateObjectsTooltips() {
        const t = translations[currentLang];
        document.getElementById('obj1-fetch-btn').setAttribute('data-tooltip', t.obj1Fetch);
        document.getElementById('obj1-prev-btn').setAttribute('data-tooltip', t.obj1Prev);
        document.getElementById('obj1-open-btn').setAttribute('data-tooltip', t.obj1Open);
        document.getElementById('obj1-next-btn').setAttribute('data-tooltip', t.obj1Next);
        document.getElementById('obj1-scrape-btn').setAttribute('data-tooltip', t.obj1Scrape);
        document.getElementById('obj1-delete-btn').setAttribute('data-tooltip', t.obj1DeleteCurrent);
        document.getElementById('obj1-delete-all-btn').setAttribute('data-tooltip', t.obj1DeleteAll);
    }

    // Print button
    const printBtn = document.getElementById('print-btn');
    if (printBtn) {
        printBtn.addEventListener('click', () => window.print());
    }

    // Email results button
    const emailBtn = document.getElementById('email-btn');
    if (emailBtn) {
        emailBtn.addEventListener('click', () => {
            const inputs = getInputs();
            
            // Helper function to pad labels for alignment
            const pad = (label, value) => {
                const maxLen = 25;
                const padding = ' '.repeat(Math.max(0, maxLen - label.length));
                return `${label}:${padding}${value}`;
            };
            
            const body = [
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '    LGH VINSTKALKYLATOR - RESULTAT',
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                '',
                '‚îÄ‚îÄ‚îÄ OBJEKT INFORMATION ‚îÄ‚îÄ‚îÄ',
                '',
                pad('Namn', inputs.objName || '(ej angiven)'),
                pad('Kontakt', inputs.objContact || '(ej angiven)'),
                pad('Fastighetsbeskrivning', inputs.objDescription || '(ej angiven)'),
                '',
                '‚îÄ‚îÄ‚îÄ BER√ÑKNINGSDATA ‚îÄ‚îÄ‚îÄ',
                '',
                pad('F√∂rs√§ljningspris', formatSEK(inputs.forsaljningspris) + ' kr'),
                pad('L√•n', formatSEK(inputs.lan) + ' kr'),
                pad('Ink√∂pspris', formatSEK(inputs.inkopspris) + ' kr'),
                pad('M√§klararvode', formatSEK(inputs.maklararvode) + ' kr'),
                pad('Styling', formatSEK(inputs.styling) + ' kr'),
                pad('Fotografering', formatSEK(inputs.fotografering) + ' kr'),
                pad('Renoveringskostnader', formatSEK(inputs.renoveringskostnader) + ' kr'),
                pad('√ñvriga avdragsgilla', formatSEK(inputs.ovriga) + ' kr'),
                pad('Kapitaltillskott', formatSEK(inputs.kapitaltillskott) + ' kr'),
                '',
                '‚îÄ‚îÄ‚îÄ RESULTAT ‚îÄ‚îÄ‚îÄ',
                '',
                pad('Totalt avdrag', document.getElementById('result-calc1').textContent),
                pad('Vinst f√∂re skatt', document.getElementById('result-calc2').textContent),
                pad('Skatt', document.getElementById('result-calc3').textContent),
                pad('Nettoresultat', document.getElementById('result-calc4').textContent),
                pad('Vinst efter l√•n', document.getElementById('result-calc5').textContent),
                pad('Slutlikvid', document.getElementById('result-slutlikvid').textContent),
                '',
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
                'Ber√§knat med LGH Vinstkalkylator',
                'https://howcan66.github.io/vinst-p--lgh/',
                '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            ].join('\n');

            const subject = 'LGH Vinstkalkylator Resultat';
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        });
    }

    // Clear saved data button
    const clearBtn = document.getElementById('clear-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            const ok = confirm(currentLang === 'sv' ? 'Radera sparade data?' : 'Clear saved data?');
            if (ok) {
                localStorage.removeItem('lghCalculatorData');
                location.reload();
            }
        });
    }

    // Set timestamp
    function updateTimestamp() {
        const now = new Date();
        const yy = String(now.getFullYear()).slice(-2);
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const min = String(now.getMinutes()).padStart(2, '0');
        const timestamp = `${yy}.${mm}.${dd} ${hh}:${min}`;
        const timeLabel = currentLang === 'sv' ? 'Lokal Tid' : 'Local Time';
        document.getElementById('footer-left').textContent = timeLabel + ' ' + timestamp;
    }

    // Initial calculation and timestamp
    // localStorage - Save data
    function saveData() {
        const data = {
            forsaljningspris: document.getElementById('forsaljningspris').value,
            inkopspris_kopare: document.getElementById('inkopspris_kopare').value,
            lan: document.getElementById('lan').value,
        const data = {
            objName: document.getElementById('obj-name').value,
            objContact: document.getElementById('obj-contact').value,
            objDescription: document.getElementById('obj-description').value,
            forsaljningspris: document.getElementById('forsaljningspris').value,
            inkopspris_kopare: document.getElementById('inkopspris_kopare').value,
            lan: document.getElementById('lan').value,
            inkopspris: document.getElementById('inkopspris').value,
            maklararvode: document.getElementById('maklararvode').value,
            renoveringskostnader: document.getElementById('renoveringskostnader').value,
            kapitaltillskott: document.getElementById('kapitaltillskott').value,
            skattesats: document.getElementById('skattesats').value,
            obj1Url: document.getElementById('obj1-url') ? document.getElementById('obj1-url').value : '',
            language: currentLang,
            timestamp: new Date().toISOString()
        };
        try {
            localStorage.setItem('lghCalculatorData', JSON.stringify(data));
        } catch (e) {
            console.error('Could not save data:', e);
        }
    }

    // localStorage - Load data
    function loadData() {
        // Load objects memory first (for Sales Objects)
        loadObjectsMemory();
        
        try {
            const saved = localStorage.getItem('lghCalculatorData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('obj-name').value = data.objName || '';
                document.getElementById('obj-contact').value = data.objContact || '';
                document.getElementById('obj-description').value = data.objDescription || '';
                document.getElementById('forsaljningspris').value = data.forsaljningspris || 4350000;
                document.getElementById('inkopspris_kopare').value = data.inkopspris_kopare || '';
                document.getElementById('lan').value = data.lan || 1950000;
                document.getElementById('inkopspris').value = data.inkopspris || 380000;
                document.getElementById('maklararvode').value = data.maklararvode || 65000;
                document.getElementById('renoveringskostnader').value = data.renoveringskostnader || 200000;
                document.getElementById('kapitaltillskott').value = data.kapitaltillskott || 10000;
                document.getElementById('skattesats').value = data.skattesats || 22;
                if (data.language && data.language !== currentLang) {
                    setLanguage(data.language);
                }
            }
        } catch (e) {
            console.error('Could not load data:', e);
        }
        
        // Update UI for current object
        updateObjectsUI();
    }

    // Load saved data on page load
    loadData();

    // Initialize Sales Objects UI
    updateObjectsUI();

    // Ensure UI reflects current language on initial load
    setLanguage(currentLang);
    
    // Update objects tooltips on initial load
    updateObjectsTooltips();

    // Initial calculation and timestamp
    updateTimestamp();
    calculate();

    // Input validation - prevent negative values (numeric fields only)
    document.querySelectorAll('.number-field').forEach(input => {
        input.addEventListener('input', function(e) {
            // Remove negative sign if typed
            if (this.value.startsWith('-')) {
                this.value = this.value.replace('-', '');
            }
        });
        
        input.addEventListener('focus', function() {
            // Remove formatting for editing
            this.value = String(this.value || '').replace(/\s/g, '');
        });

        input.addEventListener('blur', function() {
            // Ensure value is valid number on blur
            const value = parseNumber(this.value);
            if (isNaN(value) || value < 0) {
                this.value = 0;
                calculate();
            } else {
                // Format with spaces for readability
                this.value = formatNumber(value);
                calculate();
            }
            // Save data after validation
            saveData();
        });
        
        // Auto-save on change
        input.addEventListener('change', saveData);
    });

    // Add event listeners for object information fields
    document.getElementById('obj-name').addEventListener('blur', saveData);
    document.getElementById('obj-name').addEventListener('change', saveData);
    document.getElementById('obj-contact').addEventListener('blur', saveData);
    document.getElementById('obj-contact').addEventListener('change', saveData);
    document.getElementById('obj-description').addEventListener('blur', saveData);
    document.getElementById('obj-description').addEventListener('change', saveData);
</script>

</body>
</html>
